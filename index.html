<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quay Video v·ªõi H∆∞·ªõng Ng·∫´u Nhi√™n</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #74ebd5, #acb6e5);
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      .video-circle {
        width: 90%;
        border-radius: 50%;
        overflow: hidden;
        border: 5px solid #fff;
        box-shadow: 0px 0px 15px rgba(0, 150, 255, 0.7);
        margin-bottom: 20px;
      }
      video {
        width: 100%;
        height: 100%;
      }
      .progress-container {
        width: 250px;
        height: 12px;
        background: #ddd;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 20px;
        display: none;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(to right, #ff416c, #ff4b2b);
      }
      .btn-custom {
        padding: 10px 20px;
        font-size: 18px;
        border-radius: 8px;
        transition: 0.3s;
      }
      .btn-custom:hover {
        opacity: 0.8;
      }
      #directionText {
        font-size: 18px;
        font-weight: bold;
        color: #fff;
        margin-top: 15px;
      }
      #stepCount {
        font-size: 18px;
        font-weight: bold;
        color: #fff;
        margin-top: 10px;
      }
      #finishControls {
        margin-top: 20px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h2 class="text-white">Quay Video v·ªõi H∆∞·ªõng Ng·∫´u Nhi√™n</h2>

    <div class="video-circle">
      <video id="video" autoplay playsinline></video>
    </div>

    <button id="startBtn" class="btn btn-primary btn-custom">
      B·∫Øt ƒë·∫ßu quay
    </button>

    <div id="progressContainer" class="progress-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>

    <p id="stepCount"></p>
    <p id="directionText"></p>

    <div id="finishControls">
      <button id="downloadBtn" class="btn btn-success btn-custom">
        T·∫£i xu·ªëng
      </button>
      <button id="resetBtn" class="btn btn-danger btn-custom">Quay l·∫°i</button>
    </div>

    <script>
      const video = document.getElementById("video");
      const startBtn = document.getElementById("startBtn");
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const directionText = document.getElementById("directionText");
      const stepCount = document.getElementById("stepCount");
      const finishControls = document.getElementById("finishControls");
      const downloadBtn = document.getElementById("downloadBtn");
      const resetBtn = document.getElementById("resetBtn");

      let mediaRecorder;
      let recordedChunks = [];
      let stream;
      let currentStep = 0;
      const stepDirections = ["Tr√°i ‚¨ÖÔ∏è", "Ph·∫£i ‚û°Ô∏è", "L√™n ‚¨ÜÔ∏è", "Tr√°i ‚¨ÖÔ∏è", "Ph·∫£i ‚û°Ô∏è"];

      // üëâ M·ªü camera ngay khi v√†o trang
      async function initCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { max: 640 },
              aspectRatio: 1,
            },
          });
          video.srcObject = stream;
        } catch (error) {
          console.error("L·ªói khi m·ªü camera:", error);
        }
      }

      // üëâ Khi ·∫•n "B·∫Øt ƒë·∫ßu" th√¨ m·ªõi ghi video
      function startRecording() {
        startBtn.style.display = "none";
        progressContainer.style.display = "block";

        if (!stream) {
          console.error("Kh√¥ng t√¨m th·∫•y stream video!");
          return;
        }

        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (event) => recordedChunks.push(event.data);
        mediaRecorder.start();

        startSteps();
      }

      function startSteps() {
        let stepIndex = 0;
        function nextStep() {
          if (stepIndex >= 5) {
            finishRecording();
          } else {
            currentStep = stepIndex;
            directionText.innerText = `H∆∞·ªõng: ${stepDirections[currentStep]}`;
            stepCount.innerText = `${stepIndex + 1}/5 ho√†n th√†nh`;
            progressBar.style.width = "0%";

            setTimeout(() => {
              progressBar.style.transition = "width 2.5s linear";
              progressBar.style.width = "100%";
            }, 100);

            setTimeout(() => {
              progressBar.style.transition = "none";
              stepIndex++;
              nextStep();
            }, 2740);
          }
        }
        nextStep();
      }

      function finishRecording() {
        mediaRecorder.stop();
        progressContainer.style.display = "none";
        directionText.innerText = "‚úÖ Ho√†n th√†nh!";
        stepCount.innerText = "";
        finishControls.style.display = "block";
      }

      function downloadVideo() {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "video.webm";
        a.click();
        URL.revokeObjectURL(url);
      }

      function reset() {
        location.reload();
      }

      // üëâ G·ªçi `initCamera()` ngay khi trang load
      initCamera();

      startBtn.addEventListener("click", startRecording);
      downloadBtn.addEventListener("click", downloadVideo);
      resetBtn.addEventListener("click", reset);
    </script>
  </body>
</html>
